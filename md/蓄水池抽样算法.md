<!--
 * @Author: tangdaoyong
 * @Date: 2021-05-07 10:09:15
 * @LastEditors: tangdaoyong
 * @LastEditTime: 2021-05-07 10:12:20
 * @Description: file content
-->
# è“„æ°´æ± é‡‡æ ·ç®—æ³•ï¼ˆReservoir Samplingï¼‰

## é—®é¢˜æè¿°åˆ†æ
é‡‡æ ·é—®é¢˜ç»å¸¸ä¼šè¢«é‡åˆ°ï¼Œæ¯”å¦‚ï¼š

ä» 100000 ä»½è°ƒæŸ¥æŠ¥å‘Šä¸­æŠ½å– 1000 ä»½è¿›è¡Œç»Ÿè®¡ã€‚
ä»ä¸€æœ¬å¾ˆåšçš„ç”µè¯ç°¿ä¸­æŠ½å– 1000 äººè¿›è¡Œå§“æ°ç»Ÿè®¡ã€‚
ä» Google æœç´¢ "Ken Thompson"ï¼Œä»ä¸­æŠ½å– 100 ä¸ªç»“æœæŸ¥çœ‹å“ªäº›æ˜¯ä»Šå¹´çš„ã€‚
è¿™äº›éƒ½æ˜¯å¾ˆåŸºæœ¬çš„é‡‡ç”¨é—®é¢˜ã€‚

æ—¢ç„¶è¯´åˆ°é‡‡æ ·é—®é¢˜ï¼Œæœ€é‡è¦çš„å°±æ˜¯åšåˆ°å…¬å¹³ï¼Œä¹Ÿå°±æ˜¯ä¿è¯æ¯ä¸ªå…ƒç´ è¢«é‡‡æ ·åˆ°çš„æ¦‚ç‡æ˜¯ç›¸åŒçš„ã€‚æ‰€ä»¥å¯ä»¥æƒ³åˆ°è¦æƒ³å®ç°è¿™æ ·çš„ç®—æ³•ï¼Œå°±éœ€è¦æ·éª°å­ï¼Œä¹Ÿå°±æ˜¯éšæœºæ•°ç®—æ³•ã€‚ï¼ˆè¿™é‡Œå°±ä¸å…·ä½“è®¨è®ºéšæœºæ•°ç®—æ³•äº†ï¼Œå‡å®šæˆ‘ä»¬æœ‰äº†ä¸€å¥—å¾ˆæˆç†Ÿçš„éšæœºæ•°ç®—æ³•äº†ï¼‰

å¯¹äºç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œè¿˜æ˜¯æ¯”è¾ƒç®€å•ï¼Œé€šè¿‡ç®—æ³•ç”Ÿæˆ [0,100000âˆ’1) é—´çš„éšæœºæ•° 1000 ä¸ªï¼Œå¹¶ä¸”ä¿è¯ä¸é‡å¤å³å¯ã€‚å†å–å‡ºå¯¹åº”çš„å…ƒç´ å³å¯ã€‚

ä½†æ˜¯å¯¹äºç¬¬äºŒå’Œç¬¬ä¸‰ä¸ªé—®é¢˜ï¼Œå°±æœ‰äº›ä¸åŒäº†ï¼Œæˆ‘ä»¬ä¸çŸ¥é“æ•°æ®çš„æ•´ä½“è§„æ¨¡æœ‰å¤šå¤§ã€‚å¯èƒ½æœ‰äººä¼šæƒ³åˆ°ï¼Œæˆ‘å¯ä»¥å…ˆå¯¹æ•°æ®è¿›è¡Œä¸€æ¬¡éå†ï¼Œè®¡ç®—å‡ºæ•°æ®çš„æ•°é‡ ğ‘ï¼Œç„¶åå†æŒ‰ç…§ä¸Šè¿°çš„æ–¹æ³•è¿›è¡Œé‡‡æ ·å³å¯ã€‚è¿™å½“ç„¶å¯ä»¥ï¼Œä½†æ˜¯å¹¶ä¸å¥½ï¼Œæ¯•ç«Ÿè¿™å¯èƒ½éœ€è¦èŠ±ä¸Šå¾ˆå¤šæ—¶é—´ã€‚ä¹Ÿå¯ä»¥å°è¯•ä¼°ç®—æ•°æ®çš„è§„æ¨¡ï¼Œä½†æ˜¯è¿™æ ·å¾—åˆ°çš„é‡‡æ ·æ•°æ®åˆ†å¸ƒå¯èƒ½å¹¶ä¸å¹³å‡ã€‚

## ç®—æ³•è¿‡ç¨‹
ç»ˆäºè¦è®²åˆ°è“„æ°´æ± é‡‡æ ·ç®—æ³•ï¼ˆReservoir Samplingï¼‰äº†ã€‚å…ˆè¯´ä¸€ä¸‹ç®—æ³•çš„è¿‡ç¨‹ï¼š

å‡è®¾æ•°æ®åºåˆ—çš„è§„æ¨¡ä¸º ğ‘›ï¼Œéœ€è¦é‡‡æ ·çš„æ•°é‡çš„ä¸º ğ‘˜ã€‚

é¦–å…ˆæ„å»ºä¸€ä¸ªå¯å®¹çº³ ğ‘˜ ä¸ªå…ƒç´ çš„æ•°ç»„ï¼Œå°†åºåˆ—çš„å‰ ğ‘˜ ä¸ªå…ƒç´ æ”¾å…¥æ•°ç»„ä¸­ã€‚

ç„¶åä»ç¬¬ ğ‘˜+1 ä¸ªå…ƒç´ å¼€å§‹ï¼Œä»¥ ğ‘˜ğ‘› çš„æ¦‚ç‡æ¥å†³å®šè¯¥å…ƒç´ æ˜¯å¦è¢«æ›¿æ¢åˆ°æ•°ç»„ä¸­ï¼ˆæ•°ç»„ä¸­çš„å…ƒç´ è¢«æ›¿æ¢çš„æ¦‚ç‡æ˜¯ç›¸åŒçš„ï¼‰ã€‚ å½“éå†å®Œæ‰€æœ‰å…ƒç´ ä¹‹åï¼Œæ•°ç»„ä¸­å‰©ä¸‹çš„å…ƒç´ å³ä¸ºæ‰€éœ€é‡‡å–çš„æ ·æœ¬ã€‚

## è¯æ˜è¿‡ç¨‹
å¯¹äºç¬¬ ğ‘– ä¸ªæ•°ï¼ˆğ‘–â‰¤ğ‘˜ï¼‰ã€‚åœ¨ ğ‘˜ æ­¥ä¹‹å‰ï¼Œè¢«é€‰ä¸­çš„æ¦‚ç‡ä¸º 1ã€‚å½“èµ°åˆ°ç¬¬ ğ‘˜+1 æ­¥æ—¶ï¼Œè¢« ğ‘˜+1 ä¸ªå…ƒç´ æ›¿æ¢çš„æ¦‚ç‡ = ğ‘˜+1 ä¸ªå…ƒç´ è¢«é€‰ä¸­çš„æ¦‚ç‡ * ğ‘– è¢«é€‰ä¸­æ›¿æ¢çš„æ¦‚ç‡ï¼Œå³ä¸º ğ‘˜ğ‘˜+1Ã—1ğ‘˜=1ğ‘˜+1ã€‚åˆ™è¢«ä¿ç•™çš„æ¦‚ç‡ä¸º 1âˆ’1ğ‘˜+1=ğ‘˜ğ‘˜+1ã€‚ä¾æ¬¡ç±»æ¨ï¼Œä¸è¢« ğ‘˜+2 ä¸ªå…ƒç´ æ›¿æ¢çš„æ¦‚ç‡ä¸º 1âˆ’ğ‘˜ğ‘˜+2Ã—1ğ‘˜=ğ‘˜+1ğ‘˜+2ã€‚åˆ™è¿è¡Œåˆ°ç¬¬ ğ‘› æ­¥æ—¶ï¼Œè¢«ä¿ç•™çš„æ¦‚ç‡ = è¢«é€‰ä¸­çš„æ¦‚ç‡ * ä¸è¢«æ›¿æ¢çš„æ¦‚ç‡ï¼Œå³ï¼š

1Ã—ğ‘˜ğ‘˜+1Ã—ğ‘˜+1ğ‘˜+2Ã—ğ‘˜+2ğ‘˜+3Ã—â€¦Ã—ğ‘›âˆ’1ğ‘›=ğ‘˜ğ‘›
å¯¹äºç¬¬ ğ‘— ä¸ªæ•°ï¼ˆğ‘—>ğ‘˜ï¼‰ã€‚åœ¨ç¬¬ ğ‘— æ­¥è¢«é€‰ä¸­çš„æ¦‚ç‡ä¸º ğ‘˜ğ‘—ã€‚ä¸è¢« ğ‘—+1 ä¸ªå…ƒç´ æ›¿æ¢çš„æ¦‚ç‡ä¸º 1âˆ’ğ‘˜ğ‘—+1Ã—1ğ‘˜=ğ‘—ğ‘—+1ã€‚åˆ™è¿è¡Œåˆ°ç¬¬ ğ‘› æ­¥æ—¶ï¼Œè¢«ä¿ç•™çš„æ¦‚ç‡ = è¢«é€‰ä¸­çš„æ¦‚ç‡ * ä¸è¢«æ›¿æ¢çš„æ¦‚ç‡ï¼Œå³ï¼š

ğ‘˜ğ‘—Ã—ğ‘—ğ‘—+1Ã—ğ‘—+1ğ‘—+2Ã—ğ‘—+2ğ‘—+3Ã—...Ã—ğ‘›âˆ’1ğ‘›=ğ‘˜ğ‘›
æ‰€ä»¥å¯¹äºå…¶ä¸­æ¯ä¸ªå…ƒç´ ï¼Œè¢«ä¿ç•™çš„æ¦‚ç‡éƒ½ä¸º ğ‘˜ğ‘›.

## ä»£ç ç¤ºä¾‹
è´´å‡ºæµ‹è¯•ç”¨çš„ç¤ºä¾‹ä»£ç ï¼ˆJava å®ç°ï¼‰ï¼š
```java
public class ReservoirSamplingTest {

    private int[] pool; // æ‰€æœ‰æ•°æ®
    private final int N = 100000; // æ•°æ®è§„æ¨¡
    private Random random = new Random();

    @Before
    public void setUp() throws Exception {
        // åˆå§‹åŒ–
        pool = new int[N];
        for (int i = 0; i < N; i++) {
            pool[i] = i;
        }
    }

    private int[] sampling(int K) {
        int[] result = new int[K];
        for (int i = 0; i < K; i++) { // å‰ K ä¸ªå…ƒç´ ç›´æ¥æ”¾å…¥æ•°ç»„ä¸­
            result[i] = pool[i];
        }

        for (int i = K; i < N; i++) { // K + 1 ä¸ªå…ƒç´ å¼€å§‹è¿›è¡Œæ¦‚ç‡é‡‡æ ·
            int r = random.nextInt(i + 1);
            if (r < K) {
                result[r] = pool[i];
            }
        }

        return result;
    }

    @Test
    public void test() throws Exception {
        for (int i : sampling(100)) {
            System.out.println(i);
        }
    }
}
```
ç»“æœå°±ä¸è´´å‡ºæ¥äº†ï¼Œæ¯•ç«Ÿæ¯æ¬¡è¿è¡Œç»“æœéƒ½ä¸ä¸€æ ·ã€‚

## æ€»ç»“
è“„æ°´æ± ç®—æ³•é€‚ç”¨äºå¯¹ä¸€ä¸ªä¸æ¸…æ¥šè§„æ¨¡çš„æ•°æ®é›†è¿›è¡Œé‡‡æ ·ã€‚ä»¥å‰åœ¨æŸä¸ªåœ°æ–¹çœ‹åˆ°è¿‡ä¸€ä¸ªé¢è¯•é¢˜ï¼Œè¯´æ˜¯ä»ä¸€ä¸ªå­—ç¬¦æµä¸­è¿›è¡Œé‡‡æ ·ï¼Œæœ€åä¿ç•™ 10 ä¸ªå­—ç¬¦ï¼Œè€Œå¹¶ä¸çŸ¥é“è¿™ä¸ªæµä»€ä¹ˆæ—¶å€™ç»“æŸï¼Œä¸”é¡»ä¿è¯æ¯ä¸ªå­—ç¬¦è¢«é‡‡æ ·åˆ°çš„å‡ ç‡ç›¸åŒã€‚ç”¨çš„å°±æ˜¯è¿™ä¸ªç®—æ³•ã€‚

åœ¨é«˜å¾·çº³çš„ TAOCP ä¸­æœ‰å¯¹äºè¿™ä¸ªç®—æ³•çš„æè¿°ï¼Œå¯ä»¥è¯´è¿™æ˜¯ä¸ªå¾ˆç²¾å·§çš„ç®—æ³•ã€‚åœ¨çœ‹åˆ°è¿™ä¸ªç®—æ³•å®ç°å‰ï¼Œå¾ˆéš¾æƒ³åˆ°å¯ä»¥é€šè¿‡è¿™æ ·çš„ä¸€ç§æ–¹å¼è¿›è¡Œé‡‡æ ·ã€‚